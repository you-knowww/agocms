{# agcms/templates/view-map-conf-form.html.twig #}
<div class='agocms-view-map-conf'>
  <p>Layers:<p>
  <div id='agocmsViewMapConfLayers'></div>
  <button onclick='agocmsViewConfigFormAddLayer();'>Add layer</button>
</div>
<template id='agocmsFeatureLayerSelect'>
  <div>
    <p>Layer:<p>
    <ol>
      <li>
        <span>Search AGO Groups to narrow Feature Service results.</span>
        <br/>
        <label>Include public groups:</label>
        <input type='checkbox'
            _="on input
                get next <input/>
                set its @d-public to my checked">
        <br/>
        <input class='agocms-featurelayer-select-group__input'
            list='agocmsFeatureLayerSelectGroupSearch-'
            d-public='false'
            autocomplete='off'
            _="on input debounced at 700ms
                -- require some search text
                if my value != ''
                  -- if selecting datalist value then bail
                  set el_datalistOps to <option/> in next <datalist/>
                  for el_datalistOp in el_datalistOps
                    if my value == el_datalistOp's value
                      -- provide id reference to service search and exit
                      send selectedGroup(groupId: el_datalistOp's @d-id) to next <input/>
                      exit
                    end
                  end
                  -- request ago group named like search term
                  call agocmsViewConfigFormGroupSearch(my value, my @d-public == 'true') then
                    set groups to the result
                    get next <datalist/>
                    set its innerHTML to ''
                    for group in groups
                      make an <option/>
                      put group's title into its innerHTML
                      put group's title into its value
                      put group's id into its @d-id
                      put it at end of next <datalist/>
                    end
                end">
        <datalist id='agocmsFeatureLayerSelectGroupSearch-'></datalist>
      </li>
      <li>
        <span>Search Feature Services within selected Group.<br/>
          *Use group search in <b>step 1</b> to narrow Feature Service results</span><br/>
        <input class='agocms-featurelayer-select-service__input'
            list='agocmsFeatureLayerSelectServiceSearch-'
            d-group=''
            autocomplete='off'
            _="on selectedGroup(groupId)
                set my @d-group to groupId
                call agocmsViewConfigFormServiceSearch(my value, groupId) then
                  set services to the result
                  get next <datalist/>
                  set its innerHTML to ''
                  for service in services
                    make an <option/>
                    put service's title into its innerHTML
                    put service's title into its value
                    put service's url into its @d-id
                    put it at end of next <datalist/>
                  end
              end
              on input(isFromFocus) debounced at 700ms
                -- validate and dont run an extra query if this is from focus
                if isFromFocus !== true and (my @d-group != '' or my value != '')
                  -- if selecting datalist value then bail
                  set el_datalistOps to <option/> in next <datalist/>
                  for el_datalistOp in el_datalistOps
                    if my value == el_datalistOp's value
                      -- provide id reference to service search and exit
                      send selectedService(serviceUrl: el_datalistOp's @d-id) to next <select/>
                      exit
                    end
                  end
                  call agocmsViewConfigFormServiceSearch(my value, my @d-group) then
                  set services to the result
                  get next <datalist/>
                  set its innerHTML to ''
                  for service in services
                    make an <option/>
                    put service's title into its innerHTML
                    put service's title into its value
                    put service's url into its @d-id
                    put it at end of next <datalist/>
                  end
                end
              end
              -- auto open datalist on click
              on focus send input(isFromFocus: true) to me">
        <datalist id='agocmsFeatureLayerSelectServiceSearch-'></datalist>
      </li>
      <li style="display: none;">
        <span>Select Layer in Feature Service.</span><br/>
        <select class='agocms-featurelayer-select-layer__select'
            d-url=''
            _="on selectedService(serviceUrl)
                set my @d-url to serviceUrl
                call agocmsViewConfigFormLayerSearch(serviceUrl) then
                  set layerGroups to the result
                  remove <optgroup/> from me
                  show the closest <li/>
                  for group in layerGroups
                    -- only allow feature layers on map
                    if group's name == 'layers'
                      make an <optgroup/>
                      set optGroup to it
                      set optGroup's @label to group's name
                      for layer in group's layers
                        make an <option/>
                        put layer's name into its innerHTML
                        put layer's id into its value
                        put it at end of optGroup
                      end
                      put optGroup at end of me
                    end
                  end
                end
                on change call agocmsViewConfigFormLayerFields(my @d-url, my value) then
                  set dm to the result
                  send populateFieldConfig(dm: dm) to next <div/>">
          <option disabled='disabled' selected='selected'>Select a layer</option>
        </select>
      </li>
      <li style="display: none;">
        <span>Configure fields</span>
        <div class='agocms-featurelayer-select-fields'
            _="on populateFieldConfig(dm)
                show the closest <li/>
                set my innerHTML to ''
                for field in dm's fields
                  make an <agocms-config-field/>
                  set el_field to it
                  call agocmsPopulateFieldConfigSlots(el_field, field)
                  put el_field at the end of me
                end
                send setLayerCrud(dm: dm) to next <ul/>
                send setLabelFieldOptions(dm: dm) to next <select/>"></div>
        <div>
          <label>Layer options:</label>
          <ul _="on setLayerCrud(dm)
                  set el_create to
                    <li.agocms-featurelayer-select-layer-crud__create/> in me
                  set el_delete to
                    <li.agocms-featurelayer-select-layer-crud__delete/> in me
                  set el_attrUpdate to
                    <li.agocms-featurelayer-select-layer-crud__attr-create/> in me
                  set el_geoUpdate to
                    <li.agocms-featurelayer-select-layer-crud__geo-update/> in me
                  call dm.capabilities.indexOf('Create')
                    if it !== -1
                      show el_create
                    else hide el_create
                    end
                  call dm.capabilities.indexOf('Delete')
                    if it !== -1
                      show el_delete
                    else hide el_delete
                    end
                  call dm.capabilities.indexOf('Update')
                    if it !== -1
                      show el_attrUpdate
                      if dm's allowGeometryUpdates === true
                        show el_geoUpdate
                      else hide el_geoUpdate
                      end
                    else
                      hide el_attrUpdate
                      hide el_geoUpdate">
            <li style='display: none;'
                class='agocms-featurelayer-select-layer-crud__create'>
              <label>Allow Create</label>
              <input type='checkbox'/>
            </li>
            <li style='display: none;'
                class='agocms-featurelayer-select-layer-crud__delete'>
              <label>Allow Delete</label>
              <input type='checkbox'/>
            </li>
            <li style='display: none;'
                class='agocms-featurelayer-select-layer-crud__geo-update'>
              <label>Allow Attribute Edit</label>
              <input type='checkbox'/>
            </li>
            <li style='display: none;'
                class='agocms-featurelayer-select-layer-crud__attr-create'>
              <label>Allow Geometry Edit</label>
              <input type='checkbox'/>
            </li>
          </ul>
          <div>
            <label>Label Field</label>
            <select
                _="on setLabelFieldOptions(dm)
                    set my innerHTML to ''
                    for field in dm's fields
                      make an <option/>
                      set el_option to it
                      set its innerHTML to field's name
                      set its value to field's name
                      -- set default to dm value
                      if dm.displayField == field's name
                        set el_option's @selected to 'selected'
                      end
                      put el_option at the end of me"></select>
            <label>Label Font Size</label>
            <select>
              <option value='6'>6</option>
              <option value='8'>8</option>
              <option value='10'>10</option>
              <option value='12'>12</option>
              <option value='14'>14</option>
              <option value='16'>16</option>
              <option value='18'>18</option>
              <option value='20'>20</option>
            </select>
            <label>Label Font Color</label>
            <input type='color'/>
            <label>Label Background Color</label>
            <input type='color'/>
            <label>Label Border Color</label>
            <input type='color'/>
          </div>
        </div>
      </li>
      <li style="display: none;">
        <label>Relationships</label>
      </li>
    </ol>
  </div>
</template>
<template id='agocmsFeatureLayerSelectField'>
  <link href="/modules/custom/agocms/assets/custom/css/productivity.css"
      rel="stylesheet" type="text/css">
  <div>
    <div>
      <label>Name (alias):&nbsp;</label>
      <p style='display: inline-block;'>
        <slot name="name"><em>Undefined</em></slot>
        &nbsp;
        (<slot name="alias"><em>NA</em></slot>)
      </p>
    </div>
    <div>
      <div class='prod-inline-block'>
        <label>Type:&nbsp;</label>
        <p style='display: inline-block;'>
          <slot name="type">*<em>Unknown</em>*</slot>
        </p>
      </div>
      <div class='prod-inline-block'>
        <label>Is Optional:</label>
        <p style='display: inline-block;'>
          <slot name="nullable">false</slot>
        </p>
      </div>
    </div>
    <div>
      <div class='prod-inline-block'>
        <label>Disabled:</label>
        <input type='checkbox'
            class='agocms-featurelayer-select-field-is-disabled'/>
      </div>
      <div class='prod-inline-block'>
        <label>Hidden:</label>
        <input type='checkbox'
            class='agocms-featurelayer-select-field-is-hidden'/>
      </div>
    </div>
    <!--
      <div style='display: none;'>
        <label>Coded Values</label>
        <ul></ul>
      </div>
      <div style='display: none;'>
        <label>Range</label>
        <p>Min: <span></span></p>
        <p>Max: <span></span></p>
      </div>
    -->
  </div>
</template>
<template id='agocmsFeatureLayerSelectFieldTextConf'>
  <div>
    <div>
      <label>Make links active:</label>
      <input type='checkbox'
          class='agocms-featurelayer-select-field-links-hyperlink'/>
    </div>
    <div>
      <label>Show images:</label>
      <select class='agocms-featurelayer-select-field-links-image'/>
        <option value='disabled'>disabled</option>
        <option value='thumbnails'>thumbnails</option>
        <option value='carousel'>carousel</option>
      </select>
    </div>
  </div>
</template>
<template id='agocmsFeatureLayerSelectCodedValues'>
  <li>
    <span class='agocms-featurelayer-select-field-codes-code'></span>
    <span class='agocms-featurelayer-select-field-codes-value'></span>
  </li>
</template>
