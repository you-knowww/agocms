{# agcms/templates/view-map-conf-form.html.twig #}
<div class='agocms-view-map-conf'>
  <p>Layers:<p>
  <div>
    <div>
      <p>Layer:<p>
      <ol>
        <li>
          <span>Search AGO Groups to narrow Feature Service results.</span><br/>
          <input class='agocms-featurelayer-select-group-search'
              id='agocms-featurelayer-select-input-search-0'
              list='agocms-featurelayer-select-group-search-0'
              d-field-name='0'
              autocomplete='off'
              _="on input debounced at 700ms
                  -- require some search text
                  if my value != ''
                    -- if selecting datalist value then bail
                    set el_datalistOps to <option/> in next <datalist/>
                    for el_datalistOp in el_datalistOps
                      if my value == el_datalistOp's value
                        -- provide id reference to service search and exit
                        send selectedGroup(groupId: el_datalistOp's @d-id) to next <input/>
                        exit
                      end
                    end
                    -- request ago group named like search term
                    call agocmsViewConfigFormGroupSearch(my value) then
                      set groups to the result
                      get next <datalist/>
                      set its innerHTML to ''
                      for group in groups
                        make an <option/>
                        put group's title into its innerHTML
                        put group's title into its value
                        put group's id into its @d-id
                        put it at end of next <datalist/>
                      end
                  end">
          <datalist id='agocms-featurelayer-select-group-search-0'></datalist>
        </li>
        <li>
          <span>Search Feature Services within selected Group.<br/>
            *Use group search in <b>step 1</b> to narrow Feature Service results</span><br/>
          <input class='agocms-featurelayer-select-service-search'
              id='agocms-featurelayer-select-service-input-0'
              list='agocms-featurelayer-select-service-search-0'
              d-field-name='0'
              d-group=''
              autocomplete='off'
              _="on selectedGroup(groupId)
                  set my @d-group to groupId
                  call agocmsViewConfigFormServiceSearch(my value, groupId) then
                    set services to the result
                    get next <datalist/>
                    set its innerHTML to ''
                    for service in services
                      make an <option/>
                      put service's title into its innerHTML
                      put service's title into its value
                      put service's url into its @d-id
                      put it at end of next <datalist/>
                    end
                end
                on input(isFromFocus) debounced at 700ms
                  -- validate and dont run an extra query if this is from focus
                  if isFromFocus !== true and (my @d-group != '' or my value != '')
                    -- if selecting datalist value then bail
                    set el_datalistOps to <option/> in next <datalist/>
                    for el_datalistOp in el_datalistOps
                      if my value == el_datalistOp's value
                        -- provide id reference to service search and exit
                        -- send selectedGroup(groupId: el_datalistOp's @d-id) to next <input/>
                        exit
                      end
                    end
                    call agocmsViewConfigFormServiceSearch(my value, my @d-group) then
                    set services to the result
                    get next <datalist/>
                    set its innerHTML to ''
                    for service in services
                      make an <option/>
                      put service's title into its innerHTML
                      put service's title into its value
                      put service's url into its @d-id
                      put it at end of next <datalist/>
                    end
                  end
                end
                -- auto open datalist on click
                on focus send input(isFromFocus: true) to me">
          <datalist id='agocms-featurelayer-select-service-search-0'></datalist>
        </li>
        <li style="display: none;">
          <span>Select Layer in Feature Service.</span><br/>
          <select class='agocms-featurelayer-select-layer-select'
              id='agocms-featurelayer-select-layer-select-0'
              d-field-name='0'></select>
        </li>
      </ol>
    </div>
  </div>
  <button>Add layer</button>
</div>
